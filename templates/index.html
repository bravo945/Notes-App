<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notes — Server Connected (Responsive)</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#2B2B2B; --sidebar:#3A3A3A; --header:#2F2F2F; --edge:#444444; --ink:#DDDDDD; --ink-weak:#AAAAAA; --ink-strong:#FFFFFF; --accent:#FFCC00; --btn:#1F1F1F; --btn-ink:#DDDDDD; --link:#9ec9ff; --shadow:0 6px 24px rgba(0,0,0,.35), 0 0 0 1px rgba(0,0,0,.25);
      --sbw:256px; --header-h:48px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 Roboto, system-ui, -apple-system, Segoe UI, Helvetica, Arial, sans-serif}

    .app{display:grid;grid-template-columns:var(--sbw) 1fr;grid-template-rows:var(--header-h) 1fr;gap:0;height:100%}

    .sidebar{grid-row:1 / -1;background:var(--sidebar);border-right:1px solid var(--edge);display:flex;flex-direction:column;position:relative}
    .files{padding:.6rem;flex:1;overflow:auto}
    .file{display:flex;align-items:center;gap:.6rem;padding:.6rem .7rem;border-radius:.5rem;color:var(--ink);text-decoration:none;cursor:pointer}
    .file:hover{background:rgba(255,255,255,.05)}
    .file.active{background:rgba(255,255,255,.07);outline:1px solid var(--edge)}
    .file .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .file.up{justify-content:center;color:var(--accent);font-weight:bold;font-size:18px}
    .file.up:hover{background:rgba(255,204,0,.1)}

    .plus-btn{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);width:40px;height:40px;border-radius:50%;background:var(--btn);border:1px solid var(--edge);color:var(--accent);font-size:22px;line-height:1;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .plus-btn:hover{background:#252525}

    .create-menu,.delete-menu{position:absolute;left:50%;bottom:60px;transform:translateX(-50%);width:min(90%,260px);background:var(--header);border:1px solid var(--edge);border-radius:.6rem;box-shadow:var(--shadow);padding:.8rem;z-index:10}
    .create-menu.hidden,.delete-menu.hidden{display:none}
    .cm-head{font-size:12px;color:var(--ink-weak);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.6rem}
    .cm-type{display:flex;gap:.45rem;margin-bottom:.6rem}
    .chip{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:.35rem;padding:.5rem .7rem;border-radius:.45rem;border:1px solid var(--edge);background:#32343a;color:var(--ink);cursor:pointer}
    .chip.selected{background:var(--accent);border-color:transparent;color:#2b2b2b;font-weight:600}
    .cm-label{display:block;font-size:12px;color:var(--ink-weak);margin:.2rem 0 .3rem}
    .cm-input{width:100%;padding:.6rem .7rem;border-radius:.45rem;border:1px solid var(--edge);background:#22242a;color:var(--ink)}
    .cm-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.8rem}
    .cm-actions .btn{padding:.6rem .9rem}

    header{grid-column:2;display:flex;align-items:center;gap:.6rem;background:var(--header);border-bottom:1px solid var(--edge);padding:.5rem .8rem}
    .path{flex:1;font:500 13px/1.2 "Roboto Mono", monospace;color:var(--accent);background:transparent;border:0;padding:.35rem .55rem;letter-spacing:.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .btn{appearance:none;background:var(--btn);border:1px solid var(--edge);color:var(--btn-ink);padding:.55rem .9rem;border-radius:.45rem;cursor:pointer}
    .btn:hover{filter:brightness(1.15)}
    .btn.primary{background:var(--accent);border-color:transparent;color:#2b2b2b}
    .btn.ghost{background:transparent}
    .status{font:12px/1.2 Roboto Mono,monospace;color:var(--ink-weak)}

    .viewer{background:var(--bg);position:relative;overflow:auto}
    .page{max-width:860px;margin:48px auto 96px;padding:0 40px}
    .page h1{color:var(--ink-strong);font-weight:700;font-size:44px;margin:0 0 12px}
    .page p{color:var(--ink);font-size:18px;line-height:1.65;margin:16px 0}
    .page a{color:var(--link);text-decoration:underline}
    .page code{font-family:"Roboto Mono", monospace;background:#1F1F1F;padding:.12rem .34rem;border-radius:.3rem;border:1px solid var(--edge);color:var(--accent)}
    .page pre{background:#1F1F1F;color:var(--ink);border:1px solid var(--edge);padding:14px;border-radius:8px;overflow:auto}
    .page ul{margin:16px 0 16px 1.2rem}
    .page li{margin:.35rem 0}
    .page blockquote{margin:20px 0;padding-left:1rem;border-left:3px solid var(--edge);color:var(--ink-weak)}

    .editor{display:none;background:var(--bg);height:100%}
    .editor.active{display:grid;grid-template-columns:1fr 1fr}
    .pane{display:flex;flex-direction:column;height:100%}
    .section{padding:.55rem .8rem;border-bottom:1px solid var(--edge);background:var(--header);color:var(--ink-weak);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    textarea{flex:1;resize:none;border:0;outline:none;background:#24262b;color:var(--ink);padding:14px;font:15px/1.5 "Roboto Mono", monospace}
    .preview{flex:1;overflow:auto;background:#2e3036}
    .preview .page{margin:0;max-width:none;padding:14px 24px}

    .empty{opacity:.7;font-size:14px;text-align:center;padding:48px 16px;color:var(--ink-weak)}
    .hidden{display:none !important}

    @media (max-width: 900px){
      .app{grid-template-columns:1fr;grid-template-rows:var(--header-h) 1fr}
      .sidebar{position:fixed;inset:0 auto 0 0;width:min(86vw, 340px);transform:translateX(-100%);transition:transform .18s ease-out;z-index:20;box-shadow:var(--shadow)}
      .sidebar.open{transform:translateX(0)}
      .files{padding-bottom:72px}
      .plus-btn{position:fixed;left:auto;right:20px;bottom:20px;transform:none;width:56px;height:56px;font-size:28px;z-index:30}
      .create-menu,.delete-menu{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);width:min(92vw, 360px)}
      header{grid-column:1}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <nav class="files" id="fileList" aria-label="Files"></nav>
      <button class="plus-btn" id="btnNew" aria-haspopup="true" aria-expanded="false" title="Create new">＋</button>
      <div class="create-menu hidden" id="createMenu" role="dialog" aria-modal="true" aria-labelledby="createTitle">
        <div class="cm-head" id="createTitle">Create</div>
        <div class="cm-type" role="tablist" aria-label="Create type">
          <button class="chip selected" data-type="m" role="tab" aria-selected="true" id="cmTabM">Markdown</button>
          <button class="chip" data-type="f" role="tab" aria-selected="false" id="cmTabF">Folder</button>
        </div>
        <label class="cm-label" for="createName">Name</label>
        <input class="cm-input" id="createName" placeholder="note.md" />
        <div class="cm-actions">
          <button class="btn ghost" id="cmCancel">Cancel</button>
          <button class="btn primary" id="cmCreate">Create</button>
        </div>
      </div>
      <div class="delete-menu hidden" id="deleteMenu" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
        <div class="cm-head" id="deleteTitle">Delete</div>
        <p style="margin:0 0 .7rem;font-size:14px;color:var(--ink)" id="deletePrompt">Are you sure you want to delete this file?</p>
        <div class="cm-actions">
          <button class="btn ghost" id="delCancel">Cancel</button>
          <button class="btn primary" id="delConfirm">Delete</button>
        </div>
      </div>
    </aside>

    <header>
      <div class="path" id="path" title="Current path">Notes/</div>
      <div style="display:flex;gap:.5rem">
        <button class="btn" id="btnEdit">Edit</button>
        <button class="btn" id="btnDelete">Delete</button>
        <button class="btn ghost" id="btnPwd">Password</button>
      </div>
      <div class="status" id="status">Idle</div>
    </header>

    <main class="viewer" id="viewer">
      <article class="page" id="page"><div class="empty">Select a note on the left to view its contents.</div></article>
    </main>

    <section class="editor" id="editor">
      <div class="pane">
        <div class="section">Editor</div>
        <textarea id="editArea" placeholder="# Start typing..."></textarea>
      </div>
      <div class="pane preview">
        <div class="section">Preview</div>
        <article class="page" id="editPreview"></article>
      </div>
      <div style="position:absolute;right:16px;top:8px;display:flex;gap:.5rem">
        <button class="btn ghost" id="btnCancel">Cancel</button>
        <button class="btn primary" id="btnSave">Save</button>
      </div>
    </section>
  </div>

  <script>
    // ====== Server wiring (adjust endpoints to match your server) ======
    const ROOT = 'BravoServer/Notes';
    const API = {
      fileStructure: '/api/fileStructure',   // POST {path}
      receiveFile:  '/api/receiveFile',      // POST {path}
      sendFile:     '/api/sendFile',         // POST {path, content, password}
      deleteFile:   '/api/deleteFile',       // POST {path, password}
      createFolder: '/api/createFolder'      // POST {path, password}
    };

    let sessionPassword = null; // cached after first prompt // cached after first prompt

    const state = {
      cwd: [],                  // array of folder segments inside ROOT
      folders: [],              // [{name}]
      files: [],                // [{name}]
      activePath: null,         // full path to active file
      activeName: null,         // filename
      activeContent: ''         // file contents
    };

    // ---- DOM refs ----
    const fileListEl = document.getElementById('fileList');
    const pathEl = document.getElementById('path');
    const pageEl = document.getElementById('page');
    const viewerEl = document.getElementById('viewer');
    const editorEl = document.getElementById('editor');
    const editArea = document.getElementById('editArea');
    const editPreview = document.getElementById('editPreview');
    const statusEl = document.getElementById('status');

    // Menus & buttons
    const btnNew = document.getElementById('btnNew');
    const menu = document.getElementById('createMenu');
    const tabM = document.getElementById('cmTabM');
    const tabF = document.getElementById('cmTabF');
    const nameInput = document.getElementById('createName');
    const cmCancel = document.getElementById('cmCancel');
    const cmCreate = document.getElementById('cmCreate');
    const delMenu = document.getElementById('deleteMenu');
    const delCancel = document.getElementById('delCancel');
    const delConfirm = document.getElementById('delConfirm');
    const deletePrompt = document.getElementById('deletePrompt');
    const btnEdit = document.getElementById('btnEdit');
    const btnDelete = document.getElementById('btnDelete');
    const btnSave = document.getElementById('btnSave');
    const btnCancel = document.getElementById('btnCancel');
    const btnPwd = document.getElementById('btnPwd');

    // ===== Helpers =====
    const currPath = () => [ROOT, ...state.cwd].join('/');
    function setStatus(msg){ statusEl.textContent = msg; }

    async function call(endpoint, payload){
      const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok){
        // Normalize common errors so we can handle them upstream
        const text = await res.text();
        const msg = text || ('HTTP '+res.status);
        const err = new Error(msg);
        err.code = res.status; // e.g., 403 for Forbidden
        throw err;
      }
      return res.json();
    }

    function mdToHtml(md){
      if(!md) return '';
      md=md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      md=md.replace(/```([\s\S]*?)```/g,(m,code)=>`<pre><code>${code}</code></pre>`);
      md=md.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>').replace(/^##\s+(.*)$/gm,'<h2>$1</h2>').replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');
      md=md.replace(/^>\s+(.*)$/gm,'<blockquote>$1</blockquote>');
      md=md.replace(/^(?:- |\* )(.*)$/gm,'<li>$1</li>');
      md=md.replace(/(<li>.*<\/li>\n?)+/g,m=>`<ul>${m}</ul>`);
      md=md.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/(^|[^*])\*(?!\s)([^*]+?)(?!\s)\*(?!\*)/g,'$1<em>$2</em>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
      md=md.replace(/^(?!<h\d|<ul|<pre|<blockquote|<li|<\/li|<\/ul)(.+)$/gm,'<p>$1</p>');
      return md;
    }

    // ===== Server-backed FS ops =====
    async function loadList(){
      setStatus('Loading…');
      const data = await call(API.fileStructure, { path: currPath() });
      state.folders = (data.directories||[]).map(d=>({name:d.name}));
      state.files   = (data.files||[]).map(f=>({name:f.name}));
      renderList(); renderPath(); setStatus(`Loaded ${state.files.length} files`);
    }

    async function openFile(name){
      const full = currPath() + '/' + name;
      setStatus('Opening…');
      const data = await call(API.receiveFile, { path: full });
      state.activePath = full; state.activeName = name; state.activeContent = data.content || '';
      pageEl.innerHTML = mdToHtml(state.activeContent);
      renderList(); renderPath(); setStatus('Opened');
    }

    async function saveActive(){
      if(!state.activePath){ alert('No file selected.'); return; }
      // ask for password if none
      if(!sessionPassword){ const p = prompt('Server password:'); if(!p) return; sessionPassword = p; }
      setStatus('Saving…');
      try{
        await call(API.sendFile, { path: state.activePath, content: editArea.value, password: sessionPassword });
        state.activeContent = editArea.value;
        pageEl.innerHTML = mdToHtml(state.activeContent);
        setStatus('Saved');
      } catch(e){
        if(e.code === 403){
          // wrong/expired password — reprompt once
          const p = prompt('Password incorrect. Enter password:');
          if(!p){ setStatus('Save cancelled'); return; }
          sessionPassword = p;
          await call(API.sendFile, { path: state.activePath, content: editArea.value, password: sessionPassword });
          state.activeContent = editArea.value;
          pageEl.innerHTML = mdToHtml(state.activeContent);
          setStatus('Saved');
        } else {
          console.error(e); setStatus('Error: '+(e.message||e)); alert('Save failed: '+(e.message||e));
        }
      }
    }

    async function deleteActive(){
      if(!state.activePath){ alert('No file selected.'); return; }
      if(!sessionPassword){ const p = prompt('Server password:'); if(!p) return; sessionPassword = p; }
      setStatus('Deleting…');
      try{
        await call(API.deleteFile, { path: state.activePath, password: sessionPassword });
      } catch(e){
        if(e.code === 403){
          const p = prompt('Password incorrect. Enter password:');
          if(!p){ setStatus('Delete cancelled'); return; }
          sessionPassword = p;
          await call(API.deleteFile, { path: state.activePath, password: sessionPassword });
        } else { console.error(e); setStatus('Error: '+(e.message||e)); alert('Delete failed: '+(e.message||e)); return; }
      }
      state.activePath = null; state.activeName = null; state.activeContent='';
      await loadList();
      pageEl.innerHTML = '<div class="empty">Select a note on the left to view its contents.</div>';
      setStatus('Deleted');
    }

    async function createFolder(name){
      if(!sessionPassword){ const p = prompt('Server password:'); if(!p) return; sessionPassword = p; }
      setStatus('Creating folder…');
      try{
        await call(API.createFolder, { path: currPath() + '/' + name, password: sessionPassword });
        await loadList();
        setStatus('Folder created');
      } catch(e){
        if(e.code === 403){
          const p = prompt('Password incorrect. Enter password:');
          if(!p){ setStatus('Create cancelled'); return; }
          sessionPassword = p;
          await call(API.createFolder, { path: currPath() + '/' + name, password: sessionPassword });
          await loadList(); setStatus('Folder created');
        } else { console.error(e); setStatus('Error: '+(e.message||e)); alert('Create failed: '+(e.message||e)); }
      }
    }

    async function createFile(name){
      if(!name.toLowerCase().endsWith('.md')) name += '.md';
      if(!sessionPassword){ const p = prompt('Server password:'); if(!p) return; sessionPassword = p; }
      const full = currPath() + '/' + name;
      setStatus('Creating file…');
      try{
        await call(API.sendFile, { path: full, content: `# ${name}

Start typing…`, password: sessionPassword });
      } catch(e){
        if(e.code === 403){
          const p = prompt('Password incorrect. Enter password:');
          if(!p){ setStatus('Create cancelled'); return; }
          sessionPassword = p;
          await call(API.sendFile, { path: full, content: `# ${name}

Start typing…`, password: sessionPassword });
        } else { console.error(e); setStatus('Error: '+(e.message||e)); alert('Create failed: '+(e.message||e)); return; }
      }
      await loadList();
      await openFile(name);
      setStatus('File created');
    }

    // ===== UI wiring =====
    function renderList(){
      fileListEl.innerHTML = '';
      if(state.cwd.length){
        const up=document.createElement('div'); up.className='file up'; up.textContent='^'; up.title='Go up one folder'; up.onclick=()=>{ state.cwd.pop(); loadList(); }; fileListEl.appendChild(up);
      }
      state.folders.forEach(f=>{ const a=document.createElement('a'); a.className='file'; a.innerHTML=`<span class="name">${f.name}/</span>`; a.onclick=()=>{ state.cwd.push(f.name); loadList(); }; fileListEl.appendChild(a); });
      state.files.forEach(file=>{ const a=document.createElement('a'); const isActive = state.activeName===file.name; a.className='file'+(isActive?' active':''); a.innerHTML=`<span class="name">${file.name}</span>`; a.onclick=()=>openFile(file.name); fileListEl.appendChild(a); });
    }

    function renderPath(){ pathEl.textContent = currPath() + (state.activeName? ('/'+state.activeName): '/'); }

    function enterEdit(){ if(!state.activePath){ alert('No file selected.'); return; } editorEl.classList.add('active'); viewerEl.style.display='none'; editArea.value = state.activeContent; editPreview.innerHTML = mdToHtml(editArea.value); }
    function exitEdit(save){ if(save) saveActive().then(()=>{ editorEl.classList.remove('active'); viewerEl.style.display='block'; }); else { editorEl.classList.remove('active'); viewerEl.style.display='block'; }}

    editArea.addEventListener('input', ()=>{ editPreview.innerHTML = mdToHtml(editArea.value); });

    // Create menu
    let createType = 'm';
    function openCreateMenu(){ menu.classList.remove('hidden'); nameInput.value = createType==='m' ? 'note.md' : 'New Folder'; setTimeout(()=>nameInput.focus(),0); }
    function closeCreateMenu(){ menu.classList.add('hidden'); nameInput.value=''; }
    function ensureMd(name){ return name.toLowerCase().endsWith('.md') ? name : name + '.md'; }
    tabM.addEventListener('click',()=>{ createType='m'; tabM.classList.add('selected'); tabF.classList.remove('selected'); nameInput.value='note.md'; nameInput.focus(); nameInput.select(); });
    tabF.addEventListener('click',()=>{ createType='f'; tabF.classList.add('selected'); tabM.classList.remove('selected'); nameInput.value='New Folder'; nameInput.focus(); nameInput.select(); });
    btnNew.addEventListener('click',(e)=>{ e.stopPropagation(); if(menu.classList.contains('hidden')) openCreateMenu(); else closeCreateMenu(); });
    cmCancel.addEventListener('click', closeCreateMenu);
    cmCreate.addEventListener('click', async ()=>{ const raw=nameInput.value.trim(); if(!raw) return; if(createType==='m'){ await createFile(ensureMd(raw)); } else { await createFolder(raw.replace(/\.md$/i,'')); } closeCreateMenu(); });
    nameInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); cmCreate.click(); } if(e.key==='Escape'){ e.preventDefault(); closeCreateMenu(); } });
    document.addEventListener('click',(e)=>{ if(!menu.classList.contains('hidden') && !menu.contains(e.target) && !btnNew.contains(e.target)) closeCreateMenu(); });

    // Delete menu
    function openDeleteMenu(){ if(!state.activeName){ alert('No file selected.'); return; } deletePrompt.textContent = `Are you sure you want to delete "${state.activeName}"?`; delMenu.classList.remove('hidden'); }
    function closeDeleteMenu(){ delMenu.classList.add('hidden'); }
    delCancel.addEventListener('click', closeDeleteMenu);
    delConfirm.addEventListener('click', async ()=>{ await deleteActive(); closeDeleteMenu(); });
    btnDelete.addEventListener('click', openDeleteMenu);
    document.addEventListener('click',(e)=>{ if(!delMenu.classList.contains('hidden') && !delMenu.contains(e.target) && e.target!==btnDelete) closeDeleteMenu(); });

    // Password button
    btnPwd.addEventListener('click', ()=>{ const p = prompt('Set/replace session password:'); if(p!==null){ sessionPassword = p || null; alert(sessionPassword? 'Password set.' : 'Password cleared.'); } });

    // Edit buttons
    btnEdit.addEventListener('click', enterEdit);
    btnSave.addEventListener('click', ()=> exitEdit(true));
    btnCancel.addEventListener('click', ()=> exitEdit(false));

    // Boot
    loadList().catch(err=>{ console.error(err); setStatus('Error: '+err.message); });
  </script>
</body>
</html>

